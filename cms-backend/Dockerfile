#
FROM python:3.13-slim

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

# ========== æ›¿æ¢ä¸ºæ¸…å Debian æºï¼ˆæ”¯æŒ bookwormï¼‰==========
RUN CODENAME=$(grep -oP 'VERSION_CODENAME=\K\w+' /etc/os-release) && \
    echo "deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $CODENAME main contrib non-free non-free-firmware" > /etc/apt/sources.list && \
    echo "deb https://mirrors.tuna.tsinghua.edu.cn/debian-security $CODENAME-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list && \
    echo "deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $CODENAME-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list


# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    git \
    curl \
    gnupg \
    xz-utils \
    openssh-client \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ========== 2. ä½¿ç”¨å›½å†…é•œåƒå®‰è£… Node.js 20.x ==========
# æ–¹æ¡ˆï¼šç›´æ¥ä¸‹è½½ Node.js äºŒè¿›åˆ¶åŒ…ï¼ˆç»•è¿‡ NodeSourceï¼‰
ENV NODE_VERSION=20.17.0
ENV NODE_DISTRO=linux-x64

# ä»æ·˜å® NPM é•œåƒä¸‹è½½ Node.js
RUN curl -fsSL https://npmmirror.com/mirrors/node/v${NODE_VERSION}/node-v${NODE_VERSION}-${NODE_DISTRO}.tar.xz | tar -xJ -C /usr/local --strip-components=1

# éªŒè¯å®‰è£…
RUN node --version && npm --version

# ========== 3. è®¾ç½® npm ä½¿ç”¨å›½å†…é•œåƒ ==========
RUN npm config set registry https://registry.npmmirror.com

# å®‰è£… Hexo CLIï¼ˆç°åœ¨èµ°æ·˜å®é•œåƒï¼Œæå¿«ï¼‰
RUN npm install -g hexo-cli && hexo --version

# ========== 4. å®‰è£… Python ä¾èµ–ï¼ˆä½ å·²ç”¨æ¸…åæºï¼Œä¿ç•™ï¼‰==========
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# å¤åˆ¶ä»£ç 
COPY . .

# ========== SSH é…ç½® ==========
RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh

# è®¾ç½® Git SSH å‘½ä»¤
ENV GIT_SSH_COMMAND="ssh -i /root/.ssh/id_rsa -o IdentitiesOnly=yes -o StrictHostKeyChecking=no"

# ========== å¯åŠ¨è„šæœ¬ï¼ˆä¿æŒä¸å˜ï¼‰==========
RUN echo '#!/bin/bash\n\
if [ -n "$TZ" ]; then\n\
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone\n\
    echo "ğŸŒ æ—¶åŒºå·²è®¾ç½®ä¸º: $TZ"\n\
fi\n\
GIT_USER_NAME="${GIT_USER_NAME:-HexoDeployer}"\n\
GIT_USER_EMAIL="${GIT_USER_EMAIL:-deploy@yourdomain.com}"\n\
git config --global user.name "$GIT_USER_NAME"\n\
git config --global user.email "$GIT_USER_EMAIL"\n\
echo "ğŸ‘¤ Git ç”¨æˆ·å·²è®¾ç½®ä¸º: $GIT_USER_NAME <$GIT_USER_EMAIL>"\n\
HOSTS="${SSH_KNOWN_HOSTS:-github.com gitee.com}"\n\
ssh-keyscan $HOSTS > /root/.ssh/known_hosts 2>/dev/null\n\
chmod 644 /root/.ssh/known_hosts\n\
echo "âœ… known_hosts å·²ç”Ÿæˆ"\n\
exec uvicorn main:app --host 0.0.0.0 --port 3000 --log-level info\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]