# Dockerfile - æ”¾åœ¨ cmsBackend/ ç›®å½•ä¸‹
# åŸºäº Python 3.11 å®˜æ–¹è½»é‡é•œåƒ
FROM python:3.13-slim

# è®¾ç½®é»˜è®¤æ—¶åŒºï¼ˆå¯åœ¨ docker-compose ä¸­è¦†ç›–ï¼‰
ENV TZ=Asia/Shanghai

# å®‰è£… Git + OpenSSH + ca-certificates
RUN apt-get update && apt-get install -y \
    git \
    curl \
    gnupg \
    openssh-client \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ========== å®‰è£… Node.js 20.x (LTS) ==========
# æ·»åŠ  NodeSource æºå¹¶å®‰è£… Node.js
# æ·»åŠ  NodeSource APT æºï¼ˆNode.js 20.xï¼‰
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/trusted.gpg.d/nodesource.gpg \
    && echo "deb [arch=amd64] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list

# å®‰è£… Node.js å’Œ npm
RUN apt-get update && apt-get install -y \
    nodejs \
    && npm install -g npm@latest \
    && npm install -g hexo-cli \
    && node --version \
    && npm --version \
    && hexo --version \
    && rm -rf /var/lib/apt/lists/*



# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# å¤åˆ¶åº”ç”¨æºç 
COPY . .

# ========== SSH é…ç½® ==========
RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh



# è®¾ç½® Git ä½¿ç”¨æŒ‡å®šç§é’¥ï¼ˆå¯åœ¨ docker-compose ä¸­è¦†ç›–ï¼‰
ENV GIT_SSH_COMMAND="ssh -i /root/.ssh/id_rsa -o IdentitiesOnly=yes"

# ========== å¯åŠ¨è„šæœ¬ï¼šåŠ¨æ€è®¾ç½®æ—¶åŒº + Git ç”¨æˆ· + known_hosts ==========
RUN echo '#!/bin/bash\n\
\n\
# ========== è®¾ç½®æ—¶åŒº ==========\n\
if [ -n "$TZ" ]; then\n\
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone\n\
    echo "ğŸŒ æ—¶åŒºå·²è®¾ç½®ä¸º: $TZ"\n\
fi\n\
\n\
# ========== è®¾ç½® Git ç”¨æˆ·ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰ ==========\n\
GIT_USER_NAME="${GIT_USER_NAME:-HexoDeployer}"\n\
GIT_USER_EMAIL="${GIT_USER_EMAIL:-deploy@yourdomain.com}"\n\
git config --global user.name "$GIT_USER_NAME"\n\
git config --global user.email "$GIT_USER_EMAIL"\n\
echo "ğŸ‘¤ Git ç”¨æˆ·å·²è®¾ç½®ä¸º: $GIT_USER_NAME <$GIT_USER_EMAIL>"\n\
\n\
# ========== ç”Ÿæˆ known_hosts ==========\n\
HOSTS="${SSH_KNOWN_HOSTS:-github.com gitee.com}"\n\
echo "ğŸ” æ­£åœ¨ä¸ºä»¥ä¸‹ä¸»æœºç”Ÿæˆ known_hosts: $HOSTS"\n\
ssh-keyscan $HOSTS > /root/.ssh/known_hosts 2>/dev/null\n\
chmod 644 /root/.ssh/known_hosts\n\
echo "âœ… known_hosts å·²ç”Ÿæˆï¼Œå…± $(wc -l < /root/.ssh/known_hosts) è¡Œ"\n\
\n\
# ========== å¯åŠ¨åº”ç”¨ ==========\n\
exec uvicorn main:app --host 0.0.0.0 --port 8000 --log-level info\n\
' > /entrypoint.sh && \
    chmod +x /entrypoint.sh

# è®¾ç½®å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/entrypoint.sh"]